<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSS Aggregator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .slider-container {
            position: relative;
        }
        .slider-percentage {
            position: absolute;
            right: 0;
            top: -20px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">RSS Aggregator</h1>
            <p class="text-gray-600">Filter, sort, and explore AI safety research papers</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Filters Sidebar -->
            <aside class="w-full lg:w-96 flex-shrink-0 space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6 space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-gray-800">Date Filter</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Quick Select</label>
                                <select id="dateQuick" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                    <option value="7">Last 7 days</option>
                                    <option value="30">Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                    <option value="365">Last year</option>
                                    <option value="all">All time</option>
                                    <option value="custom">Custom range...</option>
                                </select>
                            </div>
                            <div id="customDateRange" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input type="date" id="dateStart" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input type="date" id="dateEnd" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-xl font-semibold mb-3 text-gray-800">Feed Selection</h2>
                        <div id="feedToggles" class="flex flex-wrap gap-2">
                            <!-- Feed toggles populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">Score Weights</h2>
                        <button id="resetWeights" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Reset All</button>
                    </div>
                    <div class="space-y-4">
                        <div class="slider-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Interpretability</label>
                            <span class="slider-percentage" id="weight-interpretability-pct">16.7%</span>
                            <input type="range" id="weight-interpretability" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                        <div class="slider-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Understanding</label>
                            <span class="slider-percentage" id="weight-understanding-pct">16.7%</span>
                            <input type="range" id="weight-understanding" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                        <div class="slider-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Safety</label>
                            <span class="slider-percentage" id="weight-safety-pct">16.7%</span>
                            <input type="range" id="weight-safety" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                        <div class="slider-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Technicality</label>
                            <span class="slider-percentage" id="weight-technicality-pct">16.7%</span>
                            <input type="range" id="weight-technicality" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                        <div class="slider-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Surprisal</label>
                            <span class="slider-percentage" id="weight-surprisal-pct">16.7%</span>
                            <input type="range" id="weight-surprisal" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 space-y-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">Failure Modes</h2>
                        <div id="failureModeToggles" class="flex flex-wrap gap-2">
                            <!-- Failure mode toggles populated by JavaScript -->
                        </div>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">Primary Focus</h2>
                        <div id="primaryFocusToggles" class="flex flex-wrap gap-2">
                            <!-- Primary focus toggles populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <button id="showResults" class="w-full px-6 py-3 bg-green-600 text-white text-lg font-semibold rounded-md hover:bg-green-700 transition shadow-md">
                        Show Results
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <section class="flex-1 space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-gray-800">Articles <span id="articleCount" class="text-gray-500 text-lg"></span></h2>
                        <button id="shareLink" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                            Share Current View
                        </button>
                    </div>
                    <div id="articleList" class="space-y-4">
                        <!-- Articles populated by JavaScript -->
                    </div>
                </div>
            </section>
        </div>
    </div>
<script>
        const FAILURE_MODES = ['human-misuse', 'misalignment', 'societal-disruption', 'other', 'non-applicable'];
        const PRIMARY_FOCUSES = ['interpretability', 'alignment', 'robustness', 'control', 'other'];
        const GRID_KEYS = FAILURE_MODES.flatMap(fm => PRIMARY_FOCUSES.map(pf => `${fm}:${pf}`));

        // Global state
        let allArticles = [];
        let allFeeds = [];
        let selectedCategories = new Set();
        let selectedFeeds = new Set();
        const gridCells = new Map();
        let gridRequestToken = 0;

        // Get current filters from state
        function getCurrentFilters() {
            const dateQuick = document.getElementById('dateQuick').value;
            const weights = {
                interpretability: parseInt(document.getElementById('weight-interpretability').value, 10),
                understanding: parseInt(document.getElementById('weight-understanding').value, 10),
                safety: parseInt(document.getElementById('weight-safety').value, 10),
                technicality: parseInt(document.getElementById('weight-technicality').value, 10),
                surprisal: parseInt(document.getElementById('weight-surprisal').value, 10)
            };

            const dateFilter = { type: dateQuick };
            if (dateQuick === 'custom') {
                dateFilter.start = document.getElementById('dateStart').value;
                dateFilter.end = document.getElementById('dateEnd').value;
            }

            return { dateFilter, weights };
        }

        // Calculate normalized weights
        function getNormalizedWeights(weights) {
            const sum = Object.values(weights).reduce((a, b) => a + b, 0);
            if (sum === 0) {
                // All zeros: equal weights
                return {
                    interpretability: 1 / 5,
                    understanding: 1 / 5,
                    safety: 1 / 5,
                    technicality: 1 / 5,
                    surprisal: 1 / 5
                };
            }
            const normalized = {};
            for (const key in weights) {
                normalized[key] = weights[key] / sum;
            }
            return normalized;
        }

        // Update weight percentage displays
        function updateWeightDisplays() {
            const weightKeys = ['interpretability', 'understanding', 'safety', 'technicality', 'surprisal'];
            const weights = {};
            weightKeys.forEach(key => {
                weights[key] = parseInt(document.getElementById(`weight-${key}`).value, 10);
            });

            const normalized = getNormalizedWeights(weights);
            weightKeys.forEach(key => {
                const pct = (normalized[key] * 100).toFixed(1);
                document.getElementById(`weight-${key}-pct`).textContent = `${pct}%`;
            });
        }

        // Filter articles by date
        function filterByDate(articles, dateFilter) {
            if (dateFilter.type === 'all') {
                return articles;
            }

            const now = Date.now() / 1000; // current time in seconds

            if (dateFilter.type === 'custom') {
                if (!dateFilter.start && !dateFilter.end) return articles;

                const startTime = dateFilter.start ? new Date(dateFilter.start).getTime() / 1000 : 0;
                const endTime = dateFilter.end ? (new Date(dateFilter.end).getTime() / 1000) + 86399.999 : now;

                return articles.filter(article => {
                    if (!article.published_timestamp) return true;
                    return article.published_timestamp >= startTime && article.published_timestamp <= endTime;
                });
            }

            const days = parseInt(dateFilter.type, 10);
            if (isNaN(days)) {
                return articles;
            }

            const cutoff = now - (days * 24 * 60 * 60);

            return articles.filter(article => {
                if (!article.published_timestamp) return true;
                return article.published_timestamp >= cutoff;
            });
        }

        // Filter articles by categories
        function filterByCategories(articles) {
            if (selectedCategories.size === 0) {
                return articles;
            }

            return articles.filter(article => {
                const key = `${article.failure_mode}:${article.primary_focus}`;
                return selectedCategories.has(key);
            });
        }

        // Filter articles by feeds
        function filterByFeeds(articles) {
            if (selectedFeeds.size === 0) {
                return articles; // Show all if none selected
            }

            return articles.filter(article => selectedFeeds.has(article.feed_name));
        }

        // Calculate weighted score for an article
        function calculateScore(article, weights) {
            return (
                article.interpretability * weights.interpretability +
                article.understanding * weights.understanding +
                article.safety * weights.safety +
                article.technicality * weights.technicality +
                article.surprisal * weights.surprisal
            );
        }

        // Sort articles by weighted score
        function sortArticles(articles, weights) {
            const normalized = getNormalizedWeights(weights);
            return articles.sort((a, b) => {
                const scoreA = calculateScore(a, normalized);
                const scoreB = calculateScore(b, normalized);
                return scoreB - scoreA; // Descending order
            });
        }

        // Initialize the category grid once
        function initializeCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            gridCells.clear();

            FAILURE_MODES.forEach(failureMode => {
                const row = document.createElement('tr');

                const headerCell = document.createElement('th');
                headerCell.className = 'border border-gray-300 bg-gray-100 p-2';

                const headerButton = document.createElement('button');
                headerButton.className = 'row-toggle text-sm font-semibold text-blue-600 hover:text-blue-800';
                headerButton.dataset.row = failureMode;
                headerButton.textContent = failureMode;
                headerButton.addEventListener('click', () => toggleRow(failureMode));
                headerCell.appendChild(headerButton);

                row.appendChild(headerCell);

                PRIMARY_FOCUSES.forEach(primaryFocus => {
                    const key = `${failureMode}:${primaryFocus}`;
                    const cell = document.createElement('td');
                    cell.className = 'category-cell border border-gray-300 p-4 text-center';
                    cell.dataset.key = key;
                    cell.textContent = '0';

                    cell.addEventListener('click', () => toggleCategory(key));

                    row.appendChild(cell);

                    gridCells.set(key, cell);
                });

                grid.appendChild(row);
            });

            document.querySelectorAll('.col-toggle').forEach(btn => {
                btn.addEventListener('click', () => toggleCol(btn.dataset.col));
            });
        }

        function updateCategoryGridCounts(counts) {
            GRID_KEYS.forEach(key => {
                const cell = gridCells.get(key);
                if (cell) {
                    cell.textContent = counts[key] ?? 0;
                }
            });
        }

        function updateCategoryHighlights() {
            GRID_KEYS.forEach(key => {
                const cell = gridCells.get(key);
                if (cell) {
                    cell.classList.toggle('selected', selectedCategories.has(key));
                }
            });
        }

        // Toggle category cell
        function toggleCategory(key) {
            if (selectedCategories.has(key)) {
                selectedCategories.delete(key);
            } else {
                selectedCategories.add(key);
            }
            updateCategoryHighlights();
        }

        // Toggle entire row
        function toggleRow(failureMode) {
            const keys = PRIMARY_FOCUSES.map(pf => `${failureMode}:${pf}`);
            const anySelected = keys.some(k => selectedCategories.has(k));

            if (anySelected) {
                keys.forEach(k => selectedCategories.delete(k));
            } else {
                keys.forEach(k => selectedCategories.add(k));
            }

            updateCategoryHighlights();
        }

        // Toggle entire column
        function toggleCol(primaryFocus) {
            const keys = FAILURE_MODES.map(fm => `${fm}:${primaryFocus}`);
            const anySelected = keys.some(k => selectedCategories.has(k));

            if (anySelected) {
                keys.forEach(k => selectedCategories.delete(k));
            } else {
                keys.forEach(k => selectedCategories.add(k));
            }

            updateCategoryHighlights();
        }

        // Render feed toggles
        function renderFeedToggles() {
            const container = document.getElementById('feedToggles');
            container.innerHTML = '';

            allFeeds.forEach(feed => {
                const isSelected = selectedFeeds.size === 0 || selectedFeeds.has(feed);

                const toggle = document.createElement('button');
                toggle.className = `px-4 py-2 rounded-md font-medium transition ${
                    isSelected
                        ? 'bg-blue-600 text-white hover:bg-blue-700'
                        : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                }`;
                toggle.textContent = feed;
                toggle.addEventListener('click', () => toggleFeed(feed));

                container.appendChild(toggle);
            });
        }

        // Toggle feed
        function toggleFeed(feed) {
            if (selectedFeeds.has(feed)) {
                selectedFeeds.delete(feed);
            } else {
                selectedFeeds.add(feed);
            }
            renderFeedToggles();
            updateGridCounts();
        }

        // Render articles
        function renderArticles(articles) {
            const container = document.getElementById('articleList');
            const countElement = document.getElementById('articleCount');

            countElement.textContent = `(${articles.length})`;

            if (articles.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No articles match your filters.</p>';
                return;
            }

            container.innerHTML = articles.map(article => {
                const date = article.published ? new Date(article.published).toLocaleDateString() : 'Unknown date';
                const keywords = article.keywords.join(', ');

                return `
                    <div class="border border-gray-200 rounded-lg p-6 hover:shadow-lg transition">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-xl font-semibold text-blue-600 hover:text-blue-800">
                                <a href="${article.link}" target="_blank">${article.title}</a>
                            </h3>
                            <span class="text-sm text-gray-500 ml-4 whitespace-nowrap">${date}</span>
                        </div>

                        <div class="mb-3">
                            <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded mr-2">
                                ${article.feed_name}
                            </span>
                            <span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-2 py-1 rounded mr-2">
                                ${article.failure_mode}
                            </span>
                            <span class="inline-block bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded">
                                ${article.primary_focus}
                            </span>
                        </div>

                        <div class="mb-3">
                            <p class="text-gray-700 mb-2"><strong>Summary:</strong> ${article.summary_en || 'No summary available'}</p>
                            <p class="text-gray-700"><strong>摘要：</strong> ${article.summary_cn || '无摘要'}</p>
                        </div>

                        ${keywords ? `<div class="mb-3"><p class="text-sm text-gray-600"><strong>Keywords:</strong> ${keywords}</p></div>` : ''}

                        <div class="flex gap-4 text-sm">
                            <span class="text-gray-600"><strong>Interpretability:</strong> ${article.interpretability}</span>
                            <span class="text-gray-600"><strong>Understanding:</strong> ${article.understanding}</span>
                            <span class="text-gray-600"><strong>Safety:</strong> ${article.safety}</span>
                            <span class="text-gray-600"><strong>Technicality:</strong> ${article.technicality}</span>
                            <span class="text-gray-600"><strong>Surprisal:</strong> ${article.surprisal}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function fetchGridCounts(filters) {
            const params = new URLSearchParams();
            const { dateFilter } = filters;

            params.set('date', dateFilter.type);
            if (dateFilter.type === 'custom') {
                if (dateFilter.start) params.set('dateStart', dateFilter.start);
                if (dateFilter.end) params.set('dateEnd', dateFilter.end);
            }

            if (selectedFeeds.size > 0 && selectedFeeds.size !== allFeeds.length) {
                params.set('feeds', Array.from(selectedFeeds).join(','));
            }

            const query = params.toString();
            const response = await fetch(query ? `/api/grid?${query}` : '/api/grid');
            if (!response.ok) {
                throw new Error('Failed to fetch grid counts');
            }
            const data = await response.json();
            return data.counts || {};
        }

        async function updateGridCounts(presetFilters) {
            if (!gridCells.size) {
                return;
            }
            const filters = presetFilters || getCurrentFilters();
            gridRequestToken += 1;
            const token = gridRequestToken;

            try {
                const counts = await fetchGridCounts(filters);
                if (token !== gridRequestToken) return;
                updateCategoryGridCounts(counts);
            } catch (error) {
                console.error('Failed to update grid counts', error);
            }
        }

        function encodeSelectedCategories() {
            return GRID_KEYS.map(key => (selectedCategories.has(key) ? '1' : '0')).join('');
        }

        function decodeSelectedCategories(encoded) {
            const newSet = new Set();
            GRID_KEYS.forEach((key, idx) => {
                if (encoded[idx] === '1') {
                    newSet.add(key);
                }
            });
            selectedCategories = newSet;
            updateCategoryHighlights();
        }

        // Update URL with current state
        function updateURL() {
            const filters = getCurrentFilters();
            const params = new URLSearchParams();

            // Date filter
            if (filters.dateFilter.type !== '7') {
                params.set('date', filters.dateFilter.type);
                if (filters.dateFilter.type === 'custom') {
                    if (filters.dateFilter.start) params.set('dateStart', filters.dateFilter.start);
                    if (filters.dateFilter.end) params.set('dateEnd', filters.dateFilter.end);
                }
            }

            // Weights (only if not all zeros)
            const hasNonZeroWeight = Object.values(filters.weights).some(w => w > 0);
            if (hasNonZeroWeight) {
                params.set('weights', Object.values(filters.weights).join(','));
            }

            // Categories
            const categoriesBinary = encodeSelectedCategories();
            if (categoriesBinary.includes('1')) {
                params.set('categories', categoriesBinary);
            }

            // Feeds
            const feedArray = Array.from(selectedFeeds);
            if (feedArray.length > 0 && feedArray.length < allFeeds.length) {
                params.set('feeds', feedArray.join(','));
            }

            const url = params.toString() ? `?${params.toString()}` : window.location.pathname;
            window.history.replaceState({}, '', url);
        }

        // Load state from URL
        function loadStateFromURL() {
            const params = new URLSearchParams(window.location.search);

            // Date filter
            if (params.has('date')) {
                const dateType = params.get('date');
                document.getElementById('dateQuick').value = dateType;
                if (dateType === 'custom') {
                    document.getElementById('customDateRange').classList.remove('hidden');
                    if (params.has('dateStart')) {
                        document.getElementById('dateStart').value = params.get('dateStart');
                    }
                    if (params.has('dateEnd')) {
                        document.getElementById('dateEnd').value = params.get('dateEnd');
                    }
                }
            }

            // Weights
            if (params.has('weights')) {
                const weights = params.get('weights').split(',').map(w => parseInt(w, 10));
                const weightKeys = ['interpretability', 'understanding', 'safety', 'technicality', 'surprisal'];
                weights.forEach((w, i) => {
                    if (!Number.isNaN(w) && weightKeys[i]) {
                        document.getElementById(`weight-${weightKeys[i]}`).value = w;
                    }
                });
            }

            // Categories
            if (params.has('categories')) {
                const encoded = params.get('categories');
                if (/^[01]+$/.test(encoded) && encoded.length === GRID_KEYS.length) {
                    decodeSelectedCategories(encoded);
                } else {
                    selectedCategories = new Set(encoded.split(',').filter(Boolean));
                    updateCategoryHighlights();
                }
            } else {
                selectedCategories = new Set();
            }

            // Feeds
            if (params.has('feeds')) {
                selectedFeeds = new Set(params.get('feeds').split(',').filter(Boolean));
            } else {
                selectedFeeds = new Set();
            }
        }

        // Reset all weights to 0
        function resetWeights() {
            const weightKeys = ['interpretability', 'understanding', 'safety', 'technicality', 'surprisal'];
            weightKeys.forEach(key => {
                document.getElementById(`weight-${key}`).value = 0;
            });
            updateWeightDisplays();
        }

        // Share link
        function shareLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copied to clipboard!');
            });
        }

        // Update the entire view (call this when Show Results is clicked)
        async function updateView() {
            const filters = getCurrentFilters();

            await updateGridCounts(filters);

            let filtered = allArticles;
            filtered = filterByDate(filtered, filters.dateFilter);
            filtered = filterByCategories(filtered);
            filtered = filterByFeeds(filtered);

            const sorted = sortArticles([...filtered], filters.weights);

            renderArticles(sorted);
            updateWeightDisplays();
            updateURL();
        }

        // Initialize
        async function init() {
            // Fetch data
            const response = await fetch('/api/data');
            const data = await response.json();

            allArticles = data.articles;
            allFeeds = data.feeds;

            initializeCategoryGrid();
            loadStateFromURL();
            renderFeedToggles();
            updateCategoryHighlights();
            updateWeightDisplays();

            // Setup event listeners
            document.getElementById('dateQuick').addEventListener('change', (e) => {
                const isCustom = e.target.value === 'custom';
                document.getElementById('customDateRange').classList.toggle('hidden', !isCustom);
                updateGridCounts();
            });

            document.getElementById('dateStart').addEventListener('change', () => updateGridCounts());
            document.getElementById('dateEnd').addEventListener('change', () => updateGridCounts());

            ['interpretability', 'understanding', 'safety', 'technicality', 'surprisal'].forEach(key => {
                document.getElementById(`weight-${key}`).addEventListener('input', updateWeightDisplays);
            });

            document.getElementById('resetWeights').addEventListener('click', resetWeights);
            document.getElementById('shareLink').addEventListener('click', shareLink);

            document.getElementById('showResults').addEventListener('click', () => {
                updateView();
            });

            await updateView();
        }

        // Start the app
        init();
    </script>

</body>
</html>
