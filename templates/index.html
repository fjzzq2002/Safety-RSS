<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Safety Research Aggregator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">
    <style>
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .slider-percentage {
            font-size: 0.875rem;
            font-weight: 600;
            color: #4E61D3;
            transition: color 0.2s ease;
        }
        .slider-percentage.pending {
            color: #93c5fd;
        }
    </style>
    <script>
        window.WEIGHT_KEYS = [
            "interpretability",
            "understanding",
            "safety",
            "technicality",
            "nontechnicality",
            "surprisal"
        ];
    </script>
</head>
<body class="m-0 h-screen overflow-hidden">
    <!-- Overlay for sidebar -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-5 lg:hidden hidden"></div>
    <div class="h-full w-full flex flex-row">
        <!-- Filters Sidebar -->
        <aside id="sidebar" class="w-96 flex-shrink-0 border-r border-gray-300 border-dashed px-6 py-8 space-y-8 overflow-y-auto transition-all duration-300 lg:relative fixed -translate-x-full z-10 bg-gray-50 h-full">
            <div class="rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold text-gray-800">AI Safety Research Aggregator</h1>
                    <button id="sidebarToggle" class="text-gray-600 hover:text-gray-800">
                        <i class="ti ti-x text-2xl"></i>
                    </button>
                </div>
                <p class="text-gray-500 mb-0 text-sm">Filter, sort, and explore AI safety research papers from RSS feeds</p>
                <div class="flex justify-between items-center mb-4 mt-8">
                    <h2 class="text-xl font-semibold text-gray-800">Score Weights</h2>
                    <button id="resetWeights" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Reset All</button>
                </div>
                <div class="space-y-4">
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="text-sm font-medium text-gray-700">Interpretability</label>
                            <span class="slider-percentage" id="weight-interpretability-pct">20.0%</span>
                        </div>
                        <input type="range" id="weight-interpretability" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="text-sm font-medium text-gray-700">Understanding</label>
                            <span class="slider-percentage" id="weight-understanding-pct">20.0%</span>
                        </div>
                        <input type="range" id="weight-understanding" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="text-sm font-medium text-gray-700">Safety</label>
                            <span class="slider-percentage" id="weight-safety-pct">20.0%</span>
                        </div>
                        <input type="range" id="weight-safety" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="text-sm font-medium text-gray-700">Technicality</label>
                            <span class="slider-percentage" id="weight-technicality-pct">20.0%</span>
                        </div>
                        <input type="range" id="weight-technicality" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="text-sm font-medium text-gray-700">Nontechnicality</label>
                            <span class="slider-percentage" id="weight-nontechnicality-pct">0.0%</span>
                        </div>
                        <input type="range" id="weight-nontechnicality" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="text-sm font-medium text-gray-700">Surprisal</label>
                            <span class="slider-percentage" id="weight-surprisal-pct">20.0%</span>
                        </div>
                        <input type="range" id="weight-surprisal" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                </div>
                <div class="mt-8">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800">Filter</h2>
                    <div class="space-y-4">
                        <div>
                            <select id="dateQuick" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                <option value="3">Last 3 days</option>
                                <option value="7" selected>Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                                <option value="all">All time</option>
                                <option value="custom">Custom range...</option>
                            </select>
                            <div id="customDateRange" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input type="date" id="dateStart" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input type="date" id="dateEnd" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="border-t border-gray-200 pt-4 space-y-4">
                                <div class="text-sm text-gray-500 font-semibold uppercase tracking-wide">Primary Focus</div>
                                <div id="primaryFocusToggles" class="flex flex-wrap gap-2">
                                    <!-- Primary focus toggles populated by JavaScript -->
                                </div>
                                <div class="text-sm text-gray-500 font-semibold uppercase tracking-wide mt-4">Failure Modes</div>
                                <div id="failureModeToggles" class="flex flex-wrap gap-2">
                                    <!-- Failure mode toggles populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h2 class="text-xl font-semibold mb-3 text-gray-800">Feed Selection</h2>
                        <div id="feedToggles" class="flex flex-wrap gap-2">
                            <!-- Feed toggles populated by JavaScript -->
                        </div>
                    </div>

                    <div class="mt-8">
                        <h2 class="text-xl font-semibold mb-3 text-gray-800">Customization</h2>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ArXiv Link Format</label>
                            <select id="arxiv-link-format" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                                <option value="papers.cool">papers.cool</option>
                                <option value="arxiv-abs">arxiv.org</option>
                                <option value="arxiv-pdf">arxiv.org (PDF)</option>
                                <option value="alphaxiv">alphaxiv.org</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-summary" class="w-4 h-4 rounded accent-blue-600" checked>
                                <span class="text-sm text-gray-700">Show English Summary</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-summary-cn" class="w-4 h-4 rounded accent-blue-600" checked>
                                <span class="text-sm text-gray-700">Show Chinese Summary (摘要)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-keywords" class="w-4 h-4 rounded accent-blue-600" checked>
                                <span class="text-sm text-gray-700">Show Keywords</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-scores" class="w-4 h-4 rounded accent-blue-600" checked>
                                <span class="text-sm text-gray-700">Show Scores</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-authors" class="w-4 h-4 rounded accent-blue-600" checked>
                                <span class="text-sm text-gray-700">Show Authors</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <section class="flex-1 min-w-0 p-4 sm:p-6 lg:p-10 overflow-y-auto">
            <div class="bg-white rounded-lg sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <button id="openSidebar" class="text-gray-600 hover:text-gray-800">
                            <i class="ti ti-menu-2 text-2xl"></i>
                        </button>
                        <h2 class="text-2xl font-semibold text-gray-800">Recent Research <span id="articleCount" class="text-gray-500 text-lg"></span></h2>
                    </div>
                    <button id="shareLink" class="text-gray-600 hover:text-gray-800 self-end">
                        <i class="ti ti-share-2 text-2xl"></i>
                    </button>
                </div>
                <div class="flex flex-wrap items-center justify-between gap-3 mb-4" id="articleControls">
                    <p id="resultSummary" class="text-sm text-gray-600">Loading articles...</p>
                    <div class="flex items-center gap-3 flex-wrap">
                        <label class="flex items-center gap-2 text-sm text-gray-600">
                            <span>Per page</span>
                            <select id="pageSize" class="border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                            </select>
                        </label>
                        <div class="flex items-center gap-2">
                            <button id="prevPage" class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Prev
                            </button>
                            <span id="pageInfo" class="text-sm text-gray-600 w-28 text-center">Page 1 of 1</span>
                            <button id="nextPage" class="px-3 py-1 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Next
                            </button>
                        </div>
                    </div>
                </div>
                <div id="articleList" class="space-y-4">
                    <!-- Articles populated by JavaScript -->
                </div>
            </div>
        </section>
    </div>
<script>

        const FAILURE_MODES = ['human-misuse', 'misalignment', 'societal-disruption', 'other', 'non-applicable'];
        const PRIMARY_FOCUSES = ['interpretability', 'alignment', 'robustness', 'control', 'other'];
        const PRIMARY_FOCUS_COLORS = {
            interpretability: '#a855f7',
            alignment: '#e06814',
            robustness: '#16a34a',
            control: '#e6126e',
            other: '#475569'
        };
        const GRID_KEYS = FAILURE_MODES.flatMap(fm => PRIMARY_FOCUSES.map(pf => `${fm}:${pf}`));
        const formatLabel = (value) => value.replace(/-/g, ' ').replace(/\b\w/g, (char) => char.toUpperCase());
        const PRIMARY_FOCUS_ICONS = {
            interpretability: 'ti ti-microscope',
            alignment: 'ti ti-heart-handshake',
            robustness: 'ti ti-shield-half',
            control: 'ti ti-prison'
        };
        const FAILURE_MODE_ICONS = {
            'human-misuse': 'ti ti-user-exclamation',
            misalignment: 'ti ti-mood-sad-dizzy',
            'societal-disruption': 'ti ti-world-bolt',
            other: 'ti ti-route-x-2'
        };

        const PAGE_SIZE_DEFAULT = 100;

        // Global state
        let allFeeds = [];
        let selectedFailureModes = new Set();
        let selectedPrimaryFocuses = new Set();
        let selectedFeeds = new Set();
        let sliderUpdateTimeout = null;
        let sidebarOpen = false;
        let showSummary = true;
        let showSummaryCn = true;
        let showKeywords = true;
        let showScores = true;
        let showAuthors = true;
        let arxivLinkFormat = 'arxiv-pdf';
        let currentArticles = [];
        let totalArticles = 0;
        let totalPages = 0;
        let currentPage = 1;
        let pageSize = PAGE_SIZE_DEFAULT;
        let isLoadingArticles = false;
        let currentFetchToken = 0;

        // Transform arxiv links based on format preference
        function transformArxivLink(link) {
            // Match patterns for different sources
            const patterns = [
                { regex: /papers\.cool\/arxiv\/(\d+\.\d+)/, id: 1 },
                { regex: /arxiv\.org\/(abs|pdf)\/(\d+\.\d+)/, id: 2 },
                { regex: /alphaxiv\.org\/abs\/(\d+\.\d+)/, id: 1 }
            ];

            let arxivId = null;
            for (const pattern of patterns) {
                const match = link.match(pattern.regex);
                if (match) {
                    arxivId = match[pattern.id];
                    break;
                }
            }

            if (!arxivId) return link; // Not an arxiv link, return original

            // Transform based on selected format
            switch (arxivLinkFormat) {
                case 'arxiv-abs':
                    return `https://arxiv.org/abs/${arxivId}`;
                case 'arxiv-pdf':
                    return `https://arxiv.org/pdf/${arxivId}`;
                case 'alphaxiv':
                    return `https://alphaxiv.org/abs/${arxivId}`;
                case 'papers.cool':
                default:
                    return `https://papers.cool/arxiv/${arxivId}`;
            }
        }

        // Sidebar toggle functions
        function toggleSidebar(open) {
            sidebarOpen = open;
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const isLargeScreen = window.innerWidth >= 1024;

            if (open) {
                sidebar.classList.remove('-translate-x-full', 'lg:hidden');
                sidebar.classList.add('translate-x-0');
                // Only show overlay on small screens
                if (!isLargeScreen) {
                    overlay.classList.remove('hidden');
                }
            } else {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                // On large screens, also add lg:hidden so it doesn't take up space
                if (isLargeScreen) {
                    sidebar.classList.add('lg:hidden');
                }
                overlay.classList.add('hidden');
            }
            updateURL();
        }

        function getCurrentFilters() {
            const dateQuick = document.getElementById('dateQuick').value;
            const weights = {
                interpretability: parseInt(document.getElementById('weight-interpretability').value, 10),
                understanding: parseInt(document.getElementById('weight-understanding').value, 10),
                safety: parseInt(document.getElementById('weight-safety').value, 10),
                technicality: parseInt(document.getElementById('weight-technicality').value, 10),
                nontechnicality: parseInt(document.getElementById('weight-nontechnicality').value, 10),
                surprisal: parseInt(document.getElementById('weight-surprisal').value, 10)
            };

            const dateFilter = { type: dateQuick };
            if (dateQuick === 'custom') {
                dateFilter.start = document.getElementById('dateStart').value;
                dateFilter.end = document.getElementById('dateEnd').value;
            }

            return { dateFilter, weights };
        }

        function getNormalizedWeights(weights) {
            const sum = Object.values(weights).reduce((a, b) => a + b, 0);
            if (sum === 0) {
                const normalized = {};
                const baselineKeys = WEIGHT_KEYS.filter(key => key !== 'nontechnicality');
                const equal = baselineKeys.length > 0 ? 1 / baselineKeys.length : 0;
                baselineKeys.forEach(key => {
                    normalized[key] = equal;
                });
                normalized.nontechnicality = 0;
                return normalized;
            }
            const normalized = {};
            WEIGHT_KEYS.forEach(key => {
                const value = weights[key] || 0;
                normalized[key] = value / sum;
            });
            return normalized;
        }

        function updateWeightDisplays() {
            const weightKeys = WEIGHT_KEYS.slice();
            const weights = {};
            weightKeys.forEach(key => {
                weights[key] = parseInt(document.getElementById(`weight-${key}`).value, 10);
            });

            const normalized = getNormalizedWeights(weights);
            weightKeys.forEach(key => {
                const pct = (normalized[key] * 100).toFixed(1);
                document.getElementById(`weight-${key}-pct`).textContent = `${pct}%`;
            });
        }

        function setSliderPendingState(isPending) {
            const weightKeys = WEIGHT_KEYS.slice();
            weightKeys.forEach(key => {
                const el = document.getElementById(`weight-${key}-pct`);
                if (!el) return;
                el.classList.toggle('pending', isPending);
            });
        }

        function handleSliderInput() {
            updateWeightDisplays();
            if (sliderUpdateTimeout) {
                clearTimeout(sliderUpdateTimeout);
            }
            setSliderPendingState(true);
            sliderUpdateTimeout = setTimeout(() => {
                updateView();
                sliderUpdateTimeout = null;
            }, 2000);
        }

        function buildArticleQueryParams(filters) {
            const params = new URLSearchParams();
            params.set('page', currentPage);
            params.set('pageSize', pageSize);
            params.set('date', filters.dateFilter.type || 'all');

            if (filters.dateFilter.type === 'custom') {
                if (filters.dateFilter.start) {
                    params.set('dateStart', filters.dateFilter.start);
                }
                if (filters.dateFilter.end) {
                    params.set('dateEnd', filters.dateFilter.end);
                }
            }

            if (selectedFeeds.size > 0) {
                params.set('feeds', Array.from(selectedFeeds).join(','));
            }
            if (selectedFailureModes.size > 0) {
                params.set('failureModes', Array.from(selectedFailureModes).join(','));
            }
            if (selectedPrimaryFocuses.size > 0) {
                params.set('primaryFocuses', Array.from(selectedPrimaryFocuses).join(','));
            }

            const weightValues = WEIGHT_KEYS.map(key => filters.weights[key] || 0);
            params.set('weights', weightValues.join(','));

            return params;
        }

        function setLoadingState(isLoading) {
            isLoadingArticles = isLoading;
            const list = document.getElementById('articleList');
            const summary = document.getElementById('resultSummary');
            if (isLoading) {
                summary.textContent = 'Loading articles...';
                list.classList.add('opacity-60');
            } else {
                list.classList.remove('opacity-60');
            }
        }

        function updatePaginationControls(pagination) {
            const countElement = document.getElementById('articleCount');
            const summaryElement = document.getElementById('resultSummary');
            const pageInfo = document.getElementById('pageInfo');
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');
            const pageSizeSelect = document.getElementById('pageSize');

            pageSize = pagination.page_size || pageSize;
            if (pageSizeSelect.value !== String(pageSize)) {
                pageSizeSelect.value = String(pageSize);
            }

            totalArticles = pagination.total;
            totalPages = pagination.total_pages || 0;
            currentPage = totalArticles === 0 ? 1 : pagination.page;

            const startValue = typeof pagination.start === 'number' ? pagination.start : 0;
            const endValue = typeof pagination.end === 'number' ? pagination.end : 0;
            const displayTotalPages = totalPages || (totalArticles === 0 ? 1 : 0);
            const displayCurrentPage = totalArticles === 0 ? 1 : currentPage;

            countElement.textContent = `(${totalArticles})`;

            if (totalArticles === 0) {
                summaryElement.textContent = 'No articles match your filters.';
            } else {
                summaryElement.textContent = `Showing ${startValue}–${endValue} of ${totalArticles} articles`;
            }

            pageInfo.textContent = `Page ${displayCurrentPage} of ${displayTotalPages}`;

            prevButton.disabled = !pagination.has_prev;
            nextButton.disabled = !pagination.has_next;
        }

        function goToPage(page) {
            const maxPage = totalPages || 1;
            const targetPage = Math.max(1, Math.min(page, maxPage));
            if (targetPage === currentPage) {
                return;
            }
            currentPage = targetPage;
            updateView({ preservePage: true });
        }

        function renderErrorState() {
            const container = document.getElementById('articleList');
            container.innerHTML = '<p class="text-red-500 text-center py-8">Failed to load articles. Please try again.</p>';
            document.getElementById('articleCount').textContent = '';
            document.getElementById('resultSummary').textContent = 'Failed to load articles. Please try again.';
            document.getElementById('pageInfo').textContent = 'Page - of -';
            document.getElementById('prevPage').disabled = true;
            document.getElementById('nextPage').disabled = true;
        }

        function renderFeedToggles() {
            const container = document.getElementById('feedToggles');
            container.innerHTML = '';

            // Separate arxiv feeds (always first)
            const arxivFeeds = allFeeds
                .filter(feed => feed.toLowerCase().includes('arxiv'))
                .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
            const nonArxivFeeds = allFeeds
                .filter(feed => !feed.toLowerCase().includes('arxiv'))
                .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));

            // Separate feeds by year (conferences) and others
            const yearPattern = /(20\d{2})/;
            const feedsByYear = {};
            const regularFeeds = [];

            nonArxivFeeds.forEach(feed => {
                const match = feed.match(yearPattern);
                if (match) {
                    const year = match[1];
                    if (!feedsByYear[year]) {
                        feedsByYear[year] = [];
                    }
                    feedsByYear[year].push(feed);
                } else {
                    regularFeeds.push(feed);
                }
            });

            Object.keys(feedsByYear).forEach(year => {
                feedsByYear[year].sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
            });

            // Helper function to render a group of feeds
            const renderFeedGroup = (feeds, isLast = false) => {
                const groupContainer = document.createElement('div');
                groupContainer.className = `flex flex-wrap gap-2 ${!isLast ? 'mb-2' : ''}`;

                feeds.forEach(feed => {
                    const isSelected = selectedFeeds.size === 0 || selectedFeeds.has(feed);
                    const toggle = document.createElement('button');
                    toggle.className = 'px-4 py-2 rounded-md font-medium transition border';
                    toggle.style.cssText = isSelected
                        ? 'background-color: #eef2ff; color: #1f2937; border-color: #4E61D3;'
                        : 'background-color: #f9fafb; color: #1f2937; border-color: #d1d5db;';
                    toggle.textContent = feed;
                    toggle.addEventListener('click', () => toggleFeed(feed));
                    groupContainer.appendChild(toggle);
                });

                return groupContainer;
            };

            // Render arxiv feeds first
            if (arxivFeeds.length > 0) {
                container.appendChild(renderFeedGroup(arxivFeeds));
            }

            // Render year-based feeds (conferences), sorted by year descending
            const years = Object.keys(feedsByYear).sort((a, b) => b - a);
            years.forEach(year => {
                container.appendChild(renderFeedGroup(feedsByYear[year]));
            });

            // Render regular feeds last
            if (regularFeeds.length > 0) {
                const isLast = years.length === 0 && arxivFeeds.length === 0;
                container.appendChild(renderFeedGroup(regularFeeds, isLast));
            }
        }

        function toggleFeed(feed) {
            if (selectedFeeds.has(feed)) {
                selectedFeeds.delete(feed);
            } else {
                selectedFeeds.add(feed);
            }
            renderFeedToggles();
            updateView();
        }

        function renderArticles(articles) {
            const container = document.getElementById('articleList');

            if (articles.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No articles match your filters.</p>';
                return;
            }

            container.innerHTML = articles.map(article => {
                const date = article.published ? new Date(article.published).toLocaleDateString() : 'Unknown date';
                const keywords = article.keywords.join(', ');
                const authors = article.authors ? article.authors.join(', ') : '';
                const articleLink = transformArxivLink(article.link);
                const focusColor = PRIMARY_FOCUS_COLORS[article.primary_focus] || '#4E61D3';
                const focusIconClass = PRIMARY_FOCUS_ICONS[article.primary_focus];
                const failureIconClass = FAILURE_MODE_ICONS[article.failure_mode];
                const focusIconMarkup = focusIconClass ? `<i class="${focusIconClass} text-base" aria-hidden="true" title="${formatLabel(article.primary_focus)}"></i>` : '';
                const failureIconMarkup = failureIconClass ? `<i class="${failureIconClass} text-base" aria-hidden="true" title="${formatLabel(article.failure_mode)}"></i>` : '';
                const iconGroupMarkup = (focusIconMarkup || failureIconMarkup) ? `<div class="flex gap-2 text-gray-900">${focusIconMarkup}${failureIconMarkup}</div>` : '';

                return `
                    <div class="border rounded-lg p-4 sm:p-6 hover:shadow-lg transition" style="border-color: ${focusColor};">
                        <div class="mb-3">
                            <h3 class="text-xl font-semibold text-blue-600 hover:text-blue-800 ${showAuthors && authors ? 'mb-1' : 'mb-3'}">
                                <a href="${articleLink}" target="_blank" class="hover:underline">${article.title}</a>
                            </h3>
                            ${showAuthors && authors ? `<div class="mb-3.5"><p class="text-sm text-gray-600 italic">${authors}</p></div>` : ''}

                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-end gap-3">
                                <div class="flex flex-wrap gap-2">
                                    <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded">
                                        ${article.feed_name}
                                    </span>
                                    <span class="inline-block text-xs font-semibold px-2 py-1 rounded" style="background-color: ${(PRIMARY_FOCUS_COLORS[article.primary_focus] || '#4E61D3')}22; color: ${PRIMARY_FOCUS_COLORS[article.primary_focus] || '#4E61D3'};">
                                        ${article.primary_focus}
                                    </span>
                                    <span class="inline-block text-xs font-semibold px-2 py-1 rounded" style="background-color: ${article.failure_mode === 'non-applicable' ? (PRIMARY_FOCUS_COLORS['other'] || '#475569') + '22' : '#fee2e2'}; color: ${article.failure_mode === 'non-applicable' ? (PRIMARY_FOCUS_COLORS['other'] || '#475569') : '#b91c1c'};">
                                        ${article.failure_mode}
                                    </span>
                                </div>
                                <div class="flex items-center gap-2 mt-2 sm:mt-0">
                                    <span class="text-sm text-gray-500 whitespace-nowrap">${date}</span>
                                    ${iconGroupMarkup}
                                </div>
                            </div>
                        </div>

                        ${(showSummary || showSummaryCn) ? `<div class="mb-3">
                            ${showSummary ? `<p class="text-gray-700 mb-2"><strong>Summary:</strong> ${article.summary_en || 'No summary available'}</p>` : ''}
                            ${showSummaryCn ? `<p class="text-gray-700"><strong>摘要：</strong>${article.summary_cn || '无摘要'}</p>` : ''}
                        </div>` : ''}

                        ${showKeywords && keywords ? `<div class="mb-3"><p class="text-sm text-gray-600"><strong>Keywords:</strong> ${keywords}</p></div>` : ''}

                        ${showScores ? `<div class="flex flex-wrap gap-x-4 gap-y-2 text-sm">
                            <span class="text-gray-600 whitespace-nowrap"><strong>Interpretability:</strong> ${article.interpretability}</span>
                            <span class="text-gray-600 whitespace-nowrap"><strong>Understanding:</strong> ${article.understanding}</span>
                            <span class="text-gray-600 whitespace-nowrap"><strong>Safety:</strong> ${article.safety}</span>
                            <span class="text-gray-600 whitespace-nowrap"><strong>Technicality:</strong> ${article.technicality}</span>
                            <span class="text-gray-600 whitespace-nowrap"><strong>Surprisal:</strong> ${article.surprisal}</span>
                        </div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderFailureModeToggles() {
            const container = document.getElementById('failureModeToggles');
            container.innerHTML = '';

            FAILURE_MODES.forEach(mode => {
                const isSelected = selectedFailureModes.size === 0 || selectedFailureModes.has(mode);
                const toggle = document.createElement('button');
                const iconClass = FAILURE_MODE_ICONS[mode];
                toggle.className = 'px-4 py-2 rounded-md font-medium transition flex items-center gap-2 border';
                toggle.style.cssText = isSelected
                    ? 'background-color: #f3f4f6; color: #1f2937; border-color: #475569;'
                    : 'background-color: #f3f4f6; color: #1f2937; border-color: #e5e7eb;';
                toggle.setAttribute('title', formatLabel(mode));
                toggle.innerHTML = `
                    ${iconClass ? `<i class="${iconClass} text-base" aria-hidden="true"></i>` : ''}
                    <span>${formatLabel(mode)}</span>
                `;
                toggle.addEventListener('click', () => toggleFailureMode(mode));
                container.appendChild(toggle);
            });
        }

        function toggleFailureMode(mode) {
            if (selectedFailureModes.has(mode)) {
                selectedFailureModes.delete(mode);
            } else {
                selectedFailureModes.add(mode);
            }
            renderFailureModeToggles();
            updateView();
        }

        function renderPrimaryFocusToggles() {
            const container = document.getElementById('primaryFocusToggles');
            container.innerHTML = '';

            PRIMARY_FOCUSES.forEach(focus => {
                const isSelected = selectedPrimaryFocuses.size === 0 || selectedPrimaryFocuses.has(focus);
                const toggle = document.createElement('button');
                const color = PRIMARY_FOCUS_COLORS[focus] || '#4E61D3';
                const iconClass = PRIMARY_FOCUS_ICONS[focus];
                const activeStyles = `background-color: ${color}1a; color: #1f2937; border-color: ${color};`;
                const inactiveStyles = 'background-color: #f3f4f6; color: #1f2937; border-color: #e5e7eb;';
                toggle.className = 'px-4 py-2 rounded-md font-medium transition flex items-center gap-2 border';
                toggle.style.cssText = isSelected ? activeStyles : inactiveStyles;
                toggle.dataset.focusColor = color;
                toggle.setAttribute('title', formatLabel(focus));
                toggle.innerHTML = `
                    ${iconClass ? `<i class="${iconClass} text-base" aria-hidden="true"></i>` : ''}
                    <span>${formatLabel(focus)}</span>
                `;
                toggle.addEventListener('click', () => togglePrimaryFocus(focus));
                container.appendChild(toggle);
            });
        }

        function togglePrimaryFocus(focus) {
            if (selectedPrimaryFocuses.has(focus)) {
                selectedPrimaryFocuses.delete(focus);
            } else {
                selectedPrimaryFocuses.add(focus);
            }
            renderPrimaryFocusToggles();
            updateView();
        }

        function encodeSelectedCategories() {
            if (selectedFailureModes.size === 0 && selectedPrimaryFocuses.size === 0) {
                return GRID_KEYS.map(() => '0').join('');
            }

            const failures = selectedFailureModes.size ? Array.from(selectedFailureModes) : FAILURE_MODES;
            const focuses = selectedPrimaryFocuses.size ? Array.from(selectedPrimaryFocuses) : PRIMARY_FOCUSES;
            const combos = new Set();
            failures.forEach(fm => {
                focuses.forEach(pf => combos.add(`${fm}:${pf}`));
            });

            return GRID_KEYS.map(key => (combos.has(key) ? '1' : '0')).join('');
        }

        function decodeSelectedCategories(encoded) {
            if (!encoded || encoded.length !== GRID_KEYS.length) {
                selectedFailureModes = new Set();
                selectedPrimaryFocuses = new Set();
                return;
            }

            const combos = new Set();
            GRID_KEYS.forEach((key, idx) => {
                if (encoded[idx] === '1') {
                    combos.add(key);
                }
            });

            if (combos.size === 0) {
                selectedFailureModes = new Set();
                selectedPrimaryFocuses = new Set();
                return;
            }

            const failuresInCombos = new Set();
            const focusesInCombos = new Set();
            combos.forEach(key => {
                const [fm, pf] = key.split(':');
                failuresInCombos.add(fm);
                focusesInCombos.add(pf);
            });

            selectedFailureModes = failuresInCombos.size === FAILURE_MODES.length ? new Set() : failuresInCombos;
            selectedPrimaryFocuses = focusesInCombos.size === PRIMARY_FOCUSES.length ? new Set() : focusesInCombos;
        }

        function updateURL() {
            const filters = getCurrentFilters();
            const params = new URLSearchParams();

            if (filters.dateFilter.type !== '7') {
                params.set('date', filters.dateFilter.type);
                if (filters.dateFilter.type === 'custom') {
                    if (filters.dateFilter.start) params.set('dateStart', filters.dateFilter.start);
                    if (filters.dateFilter.end) params.set('dateEnd', filters.dateFilter.end);
                }
            }

            const hasNonZeroWeight = Object.values(filters.weights).some(w => w > 0);
            if (hasNonZeroWeight) {
                params.set('weights', Object.values(filters.weights).join(','));
            }

            const categoriesBinary = encodeSelectedCategories();
            if (categoriesBinary.includes('1')) {
                params.set('categories', categoriesBinary);
            }

            const feedArray = Array.from(selectedFeeds);
            if (feedArray.length > 0 && feedArray.length < allFeeds.length) {
                params.set('feeds', feedArray.join(','));
            }

            if (pageSize !== PAGE_SIZE_DEFAULT) {
                params.set('pageSize', pageSize);
            }
            if (currentPage > 1) {
                params.set('page', currentPage);
            }

            // Only persist sidebar state if it differs from default
            const isLargeScreen = window.innerWidth >= 1024;
            const defaultState = isLargeScreen;
            if (sidebarOpen !== defaultState) {
                params.set('sidebar', sidebarOpen ? '1' : '0');
            }

            // Persist customization settings only if different from defaults
            if (!showSummary) params.set('hideSummary', '1');
            if (!showSummaryCn) params.set('hideSummaryCn', '1');
            if (!showKeywords) params.set('hideKeywords', '1');
            if (!showScores) params.set('hideScores', '1');
            if (!showAuthors) params.set('hideAuthors', '1');
            if (arxivLinkFormat !== 'arxiv-pdf') params.set('arxivLink', arxivLinkFormat);

            const url = params.toString() ? `?${params.toString()}` : window.location.pathname;
            window.history.replaceState({}, '', url);
        }

        function loadStateFromURL() {
            const params = new URLSearchParams(window.location.search);

            if (params.has('date')) {
                const dateType = params.get('date');
                document.getElementById('dateQuick').value = dateType;
                if (dateType === 'custom') {
                    document.getElementById('customDateRange').classList.remove('hidden');
                    if (params.has('dateStart')) {
                        document.getElementById('dateStart').value = params.get('dateStart');
                    }
                    if (params.has('dateEnd')) {
                        document.getElementById('dateEnd').value = params.get('dateEnd');
                    }
                }
            }

            if (params.has('weights')) {
                const weights = params.get('weights').split(',').map(w => parseInt(w, 10));
                const weightKeys = WEIGHT_KEYS.slice();
                weights.forEach((w, i) => {
                    if (!Number.isNaN(w) && weightKeys[i]) {
                        document.getElementById(`weight-${weightKeys[i]}`).value = w;
                    }
                });
            }

            if (params.has('categories')) {
                const encoded = params.get('categories');
                if (/^[01]+$/.test(encoded)) {
                    decodeSelectedCategories(encoded);
                }
            }

            if (params.has('feeds')) {
                selectedFeeds = new Set(params.get('feeds').split(',').filter(Boolean));
            } else {
                selectedFeeds = new Set();
            }

            let parsedPageSize = PAGE_SIZE_DEFAULT;
            if (params.has('pageSize')) {
                const candidate = parseInt(params.get('pageSize'), 10);
                if (!Number.isNaN(candidate) && candidate > 0) {
                    parsedPageSize = candidate;
                }
            }
            const pageSizeSelect = document.getElementById('pageSize');
            if (pageSizeSelect) {
                const hasOption = Array.from(pageSizeSelect.options).some(option => option.value === String(parsedPageSize));
                if (hasOption) {
                    pageSizeSelect.value = String(parsedPageSize);
                } else {
                    parsedPageSize = parseInt(pageSizeSelect.value, 10) || PAGE_SIZE_DEFAULT;
                }
            }
            pageSize = parsedPageSize;

            currentPage = 1;
            if (params.has('page')) {
                const parsedPage = parseInt(params.get('page'), 10);
                if (!Number.isNaN(parsedPage) && parsedPage > 0) {
                    currentPage = parsedPage;
                }
            }

            // Load customization settings
            showSummary = !params.has('hideSummary');
            showSummaryCn = !params.has('hideSummaryCn');
            showKeywords = !params.has('hideKeywords');
            showScores = !params.has('hideScores');
            showAuthors = !params.has('hideAuthors');
            arxivLinkFormat = params.get('arxivLink') || 'arxiv-pdf';

            // Update checkbox states
            document.getElementById('toggle-summary').checked = showSummary;
            document.getElementById('toggle-summary-cn').checked = showSummaryCn;
            document.getElementById('toggle-keywords').checked = showKeywords;
            document.getElementById('toggle-scores').checked = showScores;
            document.getElementById('toggle-authors').checked = showAuthors;
            document.getElementById('arxiv-link-format').value = arxivLinkFormat;

            // Handle sidebar state
            const isLargeScreen = window.innerWidth >= 1024;
            if (params.has('sidebar')) {
                sidebarOpen = params.get('sidebar') === '1';
            } else {
                // Default: open on large screens, closed on small screens
                sidebarOpen = isLargeScreen;
            }

            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (sidebarOpen) {
                sidebar.classList.remove('-translate-x-full', 'lg:hidden');
                sidebar.classList.add('translate-x-0');
                if (!isLargeScreen) {
                    overlay.classList.remove('hidden');
                }
            } else {
                // Sidebar is closed
                if (isLargeScreen) {
                    sidebar.classList.add('lg:hidden');
                }
            }
        }

        function resetWeights() {
            const weightKeys = WEIGHT_KEYS.slice();
            weightKeys.forEach(key => {
                document.getElementById(`weight-${key}`).value = 0;
            });
            updateWeightDisplays();
            if (sliderUpdateTimeout) {
                clearTimeout(sliderUpdateTimeout);
                sliderUpdateTimeout = null;
            }
            setSliderPendingState(false);
            updateView();
        }

        function shareLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copied to clipboard!');
            });
        }

        async function updateView(options = {}) {
            if (sliderUpdateTimeout) {
                clearTimeout(sliderUpdateTimeout);
                sliderUpdateTimeout = null;
            }
            setSliderPendingState(false);

            const { preservePage = false } = options;
            if (!preservePage) {
                currentPage = 1;
            }

            const filters = getCurrentFilters();
            const params = buildArticleQueryParams(filters);

            const requestToken = ++currentFetchToken;
            setLoadingState(true);

            try {
                const response = await fetch(`/api/articles?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }
                const data = await response.json();
                 if (requestToken !== currentFetchToken) {
                     return;
                 }
                currentArticles = data.articles || [];
                const pagination = data.pagination || {
                    page: currentPage,
                    page_size: pageSize,
                    total: currentArticles.length,
                    total_pages: currentArticles.length > 0 ? 1 : 0,
                    has_next: false,
                    has_prev: false,
                    start: currentArticles.length > 0 ? 1 : 0,
                    end: currentArticles.length
                };
                updatePaginationControls(pagination);
                renderArticles(currentArticles);
            } catch (error) {
                console.error('Failed to load articles', error);
                if (requestToken !== currentFetchToken) {
                    return;
                }
                currentArticles = [];
                totalArticles = 0;
                totalPages = 0;
                currentPage = 1;
                renderErrorState();
            } finally {
                if (requestToken === currentFetchToken) {
                    setLoadingState(false);
                    updateWeightDisplays();
                    updateURL();
                }
            }
        }

        async function init() {
            try {
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`Failed to load metadata: ${response.status}`);
                }
                const data = await response.json();
                allFeeds = data.feeds || [];
            } catch (error) {
                console.error('Failed to load metadata', error);
                renderErrorState();
                document.getElementById('resultSummary').textContent = 'Unable to load feed metadata.';
                return;
            }

            loadStateFromURL();
            renderFeedToggles();
            renderPrimaryFocusToggles();
            renderFailureModeToggles();
            updateWeightDisplays();

            document.getElementById('pageSize').value = String(pageSize);

            document.getElementById('dateQuick').addEventListener('change', (e) => {
                const isCustom = e.target.value === 'custom';
                document.getElementById('customDateRange').classList.toggle('hidden', !isCustom);
                updateView();
            });

            document.getElementById('dateStart').addEventListener('change', () => {
                updateView();
            });
            document.getElementById('dateEnd').addEventListener('change', () => {
                updateView();
            });

            ['interpretability', 'understanding', 'safety', 'technicality', 'nontechnicality', 'surprisal'].forEach(key => {
                document.getElementById(`weight-${key}`).addEventListener('input', handleSliderInput);
            });

            document.getElementById('resetWeights').addEventListener('click', resetWeights);
            document.getElementById('shareLink').addEventListener('click', shareLink);

            document.getElementById('pageSize').addEventListener('change', (e) => {
                const value = parseInt(e.target.value, 10);
                if (Number.isNaN(value) || value <= 0) {
                    return;
                }
                pageSize = value;
                currentPage = 1;
                updateView();
            });
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    goToPage(currentPage - 1);
                }
            });
            document.getElementById('nextPage').addEventListener('click', () => {
                if (totalPages === 0) {
                    return;
                }
                if (currentPage < totalPages) {
                    goToPage(currentPage + 1);
                }
            });

            // Customization toggle event listeners
            document.getElementById('toggle-summary').addEventListener('change', (e) => {
                showSummary = e.target.checked;
                renderArticles(currentArticles);
                updateURL();
            });
            document.getElementById('toggle-summary-cn').addEventListener('change', (e) => {
                showSummaryCn = e.target.checked;
                renderArticles(currentArticles);
                updateURL();
            });
            document.getElementById('toggle-keywords').addEventListener('change', (e) => {
                showKeywords = e.target.checked;
                renderArticles(currentArticles);
                updateURL();
            });
            document.getElementById('toggle-scores').addEventListener('change', (e) => {
                showScores = e.target.checked;
                renderArticles(currentArticles);
                updateURL();
            });
            document.getElementById('toggle-authors').addEventListener('change', (e) => {
                showAuthors = e.target.checked;
                renderArticles(currentArticles);
                updateURL();
            });
            document.getElementById('arxiv-link-format').addEventListener('change', (e) => {
                arxivLinkFormat = e.target.value;
                renderArticles(currentArticles);
                updateURL();
            });

            // Sidebar toggle event listeners
            document.getElementById('openSidebar').addEventListener('click', () => toggleSidebar(true));
            document.getElementById('sidebarToggle').addEventListener('click', () => toggleSidebar(false));
            document.getElementById('sidebarOverlay').addEventListener('click', () => toggleSidebar(false));

            await updateView({ preservePage: true });
        }

        init();
</script>
