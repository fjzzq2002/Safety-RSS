<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Safety Research Aggregator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">
    <style>
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .slider-percentage {
            font-size: 0.875rem;
            font-weight: 600;
            color: #4E61D3;
            transition: color 0.2s ease;
        }
        .slider-percentage.pending {
            color: #93c5fd;
        }
    </style>
</head>
<body class="m-0 h-screen overflow-hidden">
    <!-- Overlay for sidebar -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-5 lg:hidden hidden"></div>
    <div class="h-full w-full flex flex-row">
        <!-- Filters Sidebar -->
        <aside id="sidebar" class="w-96 flex-shrink-0 border-r border-gray-300 border-dashed px-6 py-8 space-y-8 overflow-y-auto transition-all duration-300 lg:relative fixed -translate-x-full z-10 bg-gray-50 h-full">
            <div class="rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold text-gray-800">AI Safety Research Aggregator</h1>
                    <button id="sidebarToggle" class="text-gray-600 hover:text-gray-800">
                        <i class="ti ti-x text-2xl"></i>
                    </button>
                </div>
                <p class="text-gray-500 mb-0 text-sm">Filter, sort, and explore AI safety research papers from RSS feeds</p>
                <div class="flex justify-between items-center mb-4 mt-8">
                    <h2 class="text-xl font-semibold text-gray-800">Score Weights</h2>
                    <button id="resetWeights" class="text-sm text-blue-600 hover:text-blue-800 font-medium">Reset All</button>
                </div>
                <div class="space-y-4">
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="text-sm font-medium text-gray-700">Interpretability</label>
                            <span class="slider-percentage" id="weight-interpretability-pct">16.7%</span>
                        </div>
                        <input type="range" id="weight-interpretability" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="text-sm font-medium text-gray-700">Understanding</label>
                            <span class="slider-percentage" id="weight-understanding-pct">16.7%</span>
                        </div>
                        <input type="range" id="weight-understanding" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="text-sm font-medium text-gray-700">Safety</label>
                            <span class="slider-percentage" id="weight-safety-pct">16.7%</span>
                        </div>
                        <input type="range" id="weight-safety" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="text-sm font-medium text-gray-700">Technicality</label>
                            <span class="slider-percentage" id="weight-technicality-pct">16.7%</span>
                        </div>
                        <input type="range" id="weight-technicality" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                    <div class="slider-container">
                        <div class="slider-header">
                            <label class="text-sm font-medium text-gray-700">Surprisal</label>
                            <span class="slider-percentage" id="weight-surprisal-pct">16.7%</span>
                        </div>
                        <input type="range" id="weight-surprisal" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>
                </div>
                <div class="mt-8">
                    <h2 class="text-xl font-semibold mb-3 text-gray-800">Filter</h2>
                    <div class="space-y-4">
                        <div>
                            <select id="dateQuick" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                <option value="7">Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                                <option value="all">All time</option>
                                <option value="custom">Custom range...</option>
                            </select>
                            <div id="customDateRange" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                    <input type="date" id="dateStart" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                    <input type="date" id="dateEnd" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="border-t border-gray-200 pt-4 space-y-4">
                                <div class="text-sm text-gray-500 font-semibold uppercase tracking-wide">Primary Focus</div>
                                <div id="primaryFocusToggles" class="flex flex-wrap gap-2">
                                    <!-- Primary focus toggles populated by JavaScript -->
                                </div>
                                <div class="text-sm text-gray-500 font-semibold uppercase tracking-wide mt-4">Failure Modes</div>
                                <div id="failureModeToggles" class="flex flex-wrap gap-2">
                                    <!-- Failure mode toggles populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h2 class="text-xl font-semibold mb-3 text-gray-800">Feed Selection</h2>
                        <div id="feedToggles" class="flex flex-wrap gap-2">
                            <!-- Feed toggles populated by JavaScript -->
                        </div>
                    </div>

                    <div class="mt-8">
                        <h2 class="text-xl font-semibold mb-3 text-gray-800">Customization</h2>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-summary" class="w-4 h-4 rounded accent-blue-600" checked>
                                <span class="text-sm text-gray-700">Show English Summary</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-summary-cn" class="w-4 h-4 rounded accent-blue-600" checked>
                                <span class="text-sm text-gray-700">Show Chinese Summary (摘要)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-keywords" class="w-4 h-4 rounded accent-blue-600" checked>
                                <span class="text-sm text-gray-700">Show Keywords</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-scores" class="w-4 h-4 rounded accent-blue-600" checked>
                                <span class="text-sm text-gray-700">Show Scores</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="toggle-authors" class="w-4 h-4 rounded accent-blue-600" checked>
                                <span class="text-sm text-gray-700">Show Authors</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <section class="flex-1 min-w-0 p-6 lg:p-10 overflow-y-auto">
            <div class="bg-white rounded-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <button id="openSidebar" class="text-gray-600 hover:text-gray-800">
                            <i class="ti ti-menu-2 text-2xl"></i>
                        </button>
                        <h2 class="text-2xl font-semibold text-gray-800">Recent Research <span id="articleCount" class="text-gray-500 text-lg"></span></h2>
                    </div>
                    <button id="shareLink" class="text-gray-600 hover:text-gray-800 self-end">
                        <i class="ti ti-share-2 text-2xl"></i>
                    </button>
                </div>
                <div id="articleList" class="space-y-4">
                    <!-- Articles populated by JavaScript -->
                </div>
            </div>
        </section>
    </div>
<script>

        const FAILURE_MODES = ['human-misuse', 'misalignment', 'societal-disruption', 'other', 'non-applicable'];
        const PRIMARY_FOCUSES = ['interpretability', 'alignment', 'robustness', 'control', 'other'];
        const PRIMARY_FOCUS_COLORS = {
            interpretability: '#a855f7',
            alignment: '#e06814',
            robustness: '#16a34a',
            control: '#e6126e',
            other: '#475569'
        };
        const GRID_KEYS = FAILURE_MODES.flatMap(fm => PRIMARY_FOCUSES.map(pf => `${fm}:${pf}`));
        const formatLabel = (value) => value.replace(/-/g, ' ').replace(/\b\w/g, (char) => char.toUpperCase());
        const PRIMARY_FOCUS_ICONS = {
            interpretability: 'ti ti-microscope',
            alignment: 'ti ti-heart-handshake',
            robustness: 'ti ti-shield-half',
            control: 'ti ti-prison'
        };
        const FAILURE_MODE_ICONS = {
            'human-misuse': 'ti ti-user-exclamation',
            misalignment: 'ti ti-mood-sad-dizzy',
            'societal-disruption': 'ti ti-world-bolt',
            other: 'ti ti-route-x-2'
        };

        // Global state
        let allArticles = [];
        let allFeeds = [];
        let selectedFailureModes = new Set();
        let selectedPrimaryFocuses = new Set();
        let selectedFeeds = new Set();
        let sliderUpdateTimeout = null;
        let sidebarOpen = false;
        let showSummary = true;
        let showSummaryCn = true;
        let showKeywords = true;
        let showScores = true;
        let showAuthors = true;

        // Sidebar toggle functions
        function toggleSidebar(open) {
            sidebarOpen = open;
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const isLargeScreen = window.innerWidth >= 1024;

            if (open) {
                sidebar.classList.remove('-translate-x-full', 'lg:hidden');
                sidebar.classList.add('translate-x-0');
                // Only show overlay on small screens
                if (!isLargeScreen) {
                    overlay.classList.remove('hidden');
                }
            } else {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                // On large screens, also add lg:hidden so it doesn't take up space
                if (isLargeScreen) {
                    sidebar.classList.add('lg:hidden');
                }
                overlay.classList.add('hidden');
            }
            updateURL();
        }

        function getCurrentFilters() {
            const dateQuick = document.getElementById('dateQuick').value;
            const weights = {
                interpretability: parseInt(document.getElementById('weight-interpretability').value, 10),
                understanding: parseInt(document.getElementById('weight-understanding').value, 10),
                safety: parseInt(document.getElementById('weight-safety').value, 10),
                technicality: parseInt(document.getElementById('weight-technicality').value, 10),
                surprisal: parseInt(document.getElementById('weight-surprisal').value, 10)
            };

            const dateFilter = { type: dateQuick };
            if (dateQuick === 'custom') {
                dateFilter.start = document.getElementById('dateStart').value;
                dateFilter.end = document.getElementById('dateEnd').value;
            }

            return { dateFilter, weights };
        }

        function getNormalizedWeights(weights) {
            const sum = Object.values(weights).reduce((a, b) => a + b, 0);
            if (sum === 0) {
                return {
                    interpretability: 1 / 5,
                    understanding: 1 / 5,
                    safety: 1 / 5,
                    technicality: 1 / 5,
                    surprisal: 1 / 5
                };
            }
            const normalized = {};
            for (const key in weights) {
                normalized[key] = weights[key] / sum;
            }
            return normalized;
        }

        function updateWeightDisplays() {
            const weightKeys = ['interpretability', 'understanding', 'safety', 'technicality', 'surprisal'];
            const weights = {};
            weightKeys.forEach(key => {
                weights[key] = parseInt(document.getElementById(`weight-${key}`).value, 10);
            });

            const normalized = getNormalizedWeights(weights);
            weightKeys.forEach(key => {
                const pct = (normalized[key] * 100).toFixed(1);
                document.getElementById(`weight-${key}-pct`).textContent = `${pct}%`;
            });
        }

        function setSliderPendingState(isPending) {
            const weightKeys = ['interpretability', 'understanding', 'safety', 'technicality', 'surprisal'];
            weightKeys.forEach(key => {
                const el = document.getElementById(`weight-${key}-pct`);
                if (!el) return;
                el.classList.toggle('pending', isPending);
            });
        }

        function handleSliderInput() {
            updateWeightDisplays();
            if (sliderUpdateTimeout) {
                clearTimeout(sliderUpdateTimeout);
            }
            setSliderPendingState(true);
            sliderUpdateTimeout = setTimeout(() => {
                updateView();
                sliderUpdateTimeout = null;
            }, 2000);
        }

        function filterByDate(articles, dateFilter) {
            if (dateFilter.type === 'all') {
                return articles;
            }

            const now = Date.now() / 1000;

            if (dateFilter.type === 'custom') {
                if (!dateFilter.start && !dateFilter.end) return articles;

                const startTime = dateFilter.start ? new Date(dateFilter.start).getTime() / 1000 : 0;
                const endTime = dateFilter.end ? (new Date(dateFilter.end).getTime() / 1000) + 86399.999 : now;

                return articles.filter(article => {
                    if (!article.published_timestamp) return true;
                    return article.published_timestamp >= startTime && article.published_timestamp <= endTime;
                });
            }

            const days = parseInt(dateFilter.type, 10);
            if (isNaN(days)) {
                return articles;
            }

            const cutoff = now - (days * 24 * 60 * 60);

            return articles.filter(article => {
                if (!article.published_timestamp) return true;
                return article.published_timestamp >= cutoff;
            });
        }

        function filterByCategories(articles) {
            if (selectedFailureModes.size === 0 && selectedPrimaryFocuses.size === 0) {
                return articles;
            }

            return articles.filter(article => {
                const failureMatch = selectedFailureModes.size === 0 || selectedFailureModes.has(article.failure_mode);
                const focusMatch = selectedPrimaryFocuses.size === 0 || selectedPrimaryFocuses.has(article.primary_focus);
                return failureMatch && focusMatch;
            });
        }

        function filterByFeeds(articles) {
            if (selectedFeeds.size === 0) {
                return articles;
            }
            return articles.filter(article => selectedFeeds.has(article.feed_name));
        }

        function calculateScore(article, weights) {
            return (
                article.interpretability * weights.interpretability +
                article.understanding * weights.understanding +
                article.safety * weights.safety +
                article.technicality * weights.technicality +
                article.surprisal * weights.surprisal
            );
        }

        function sortArticles(articles, weights) {
            const normalized = getNormalizedWeights(weights);
            return articles.sort((a, b) => {
                const scoreA = calculateScore(a, normalized);
                const scoreB = calculateScore(b, normalized);
                return scoreB - scoreA;
            });
        }

        function renderFeedToggles() {
            const container = document.getElementById('feedToggles');
            container.innerHTML = '';

            // Separate arxiv feeds from others
            const arxivFeeds = allFeeds.filter(feed => feed.toLowerCase().includes('arxiv'));
            const otherFeeds = allFeeds.filter(feed => !feed.toLowerCase().includes('arxiv'));

            // Render arxiv feeds first if they exist
            if (arxivFeeds.length > 0) {
                const arxivContainer = document.createElement('div');
                arxivContainer.className = 'flex flex-wrap gap-2 mb-2';

                arxivFeeds.forEach(feed => {
                    const isSelected = selectedFeeds.size === 0 || selectedFeeds.has(feed);
                    const toggle = document.createElement('button');
                    toggle.className = 'px-4 py-2 rounded-md font-medium transition border';
                    toggle.style.cssText = isSelected
                        ? 'background-color: #eef2ff; color: #1f2937; border-color: #4E61D3;'
                        : 'background-color: #f9fafb; color: #1f2937; border-color: #d1d5db;';
                    toggle.textContent = feed;
                    toggle.addEventListener('click', () => toggleFeed(feed));
                    arxivContainer.appendChild(toggle);
                });

                container.appendChild(arxivContainer);
            }

            // Render other feeds
            const otherContainer = document.createElement('div');
            otherContainer.className = 'flex flex-wrap gap-2';

            otherFeeds.forEach(feed => {
                const isSelected = selectedFeeds.size === 0 || selectedFeeds.has(feed);
                const toggle = document.createElement('button');
                toggle.className = 'px-4 py-2 rounded-md font-medium transition border';
                toggle.style.cssText = isSelected
                    ? 'background-color: #eef2ff; color: #1f2937; border-color: #4E61D3;'
                    : 'background-color: #f9fafb; color: #1f2937; border-color: #d1d5db;';
                toggle.textContent = feed;
                toggle.addEventListener('click', () => toggleFeed(feed));
                otherContainer.appendChild(toggle);
            });

            container.appendChild(otherContainer);
        }

        function toggleFeed(feed) {
            if (selectedFeeds.has(feed)) {
                selectedFeeds.delete(feed);
            } else {
                selectedFeeds.add(feed);
            }
            renderFeedToggles();
            updateView();
        }

        function renderArticles(articles) {
            const container = document.getElementById('articleList');
            const countElement = document.getElementById('articleCount');

            countElement.textContent = `(${articles.length})`;

            if (articles.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No articles match your filters.</p>';
                return;
            }

            container.innerHTML = articles.map(article => {
                const date = article.published ? new Date(article.published).toLocaleDateString() : 'Unknown date';
                const keywords = article.keywords.join(', ');
                const authors = article.authors ? article.authors.join(', ') : '';
                const focusColor = PRIMARY_FOCUS_COLORS[article.primary_focus] || '#4E61D3';
                const focusIconClass = PRIMARY_FOCUS_ICONS[article.primary_focus];
                const failureIconClass = FAILURE_MODE_ICONS[article.failure_mode];
                const focusIconMarkup = focusIconClass ? `<i class="${focusIconClass} text-base" aria-hidden="true" title="${formatLabel(article.primary_focus)}"></i>` : '';
                const failureIconMarkup = failureIconClass ? `<i class="${failureIconClass} text-base" aria-hidden="true" title="${formatLabel(article.failure_mode)}"></i>` : '';
                const iconGroupMarkup = (focusIconMarkup || failureIconMarkup) ? `<div class="flex gap-2 text-gray-900">${focusIconMarkup}${failureIconMarkup}</div>` : '';

                return `
                    <div class="border rounded-lg p-6 hover:shadow-lg transition" style="border-color: ${focusColor};">
                        <div class="mb-3">
                            <h3 class="text-xl font-semibold text-blue-600 hover:text-blue-800 ${showAuthors && authors ? 'mb-2' : 'mb-3'}">
                                <a href="${article.link}" target="_blank" class="hover:underline">${article.title}</a>
                            </h3>
                            ${showAuthors && authors ? `<div class="mb-3"><p class="text-sm text-gray-600 italic">${authors}</p></div>` : ''}

                            <div class="flex justify-between items-end gap-4">
                                <div class="flex flex-wrap gap-2">
                                    <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded">
                                        ${article.feed_name}
                                    </span>
                                    <span class="inline-block bg-purple-100 text-purple-800 text-xs font-semibold px-2 py-1 rounded">
                                        ${article.failure_mode}
                                    </span>
                                    <span class="inline-block text-xs font-semibold px-2 py-1 rounded" style="background-color: ${(PRIMARY_FOCUS_COLORS[article.primary_focus] || '#4E61D3')}22; color: ${PRIMARY_FOCUS_COLORS[article.primary_focus] || '#4E61D3'};">
                                        ${article.primary_focus}
                                    </span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-500 whitespace-nowrap">${date}</span>
                                    ${iconGroupMarkup}
                                </div>
                            </div>
                        </div>

                        ${(showSummary || showSummaryCn) ? `<div class="mb-3">
                            ${showSummary ? `<p class="text-gray-700 mb-2"><strong>Summary:</strong> ${article.summary_en || 'No summary available'}</p>` : ''}
                            ${showSummaryCn ? `<p class="text-gray-700"><strong>摘要：</strong>${article.summary_cn || '无摘要'}</p>` : ''}
                        </div>` : ''}

                        ${showKeywords && keywords ? `<div class="mb-3"><p class="text-sm text-gray-600"><strong>Keywords:</strong> ${keywords}</p></div>` : ''}

                        ${showScores ? `<div class="flex gap-4 text-sm">
                            <span class="text-gray-600"><strong>Interpretability:</strong> ${article.interpretability}</span>
                            <span class="text-gray-600"><strong>Understanding:</strong> ${article.understanding}</span>
                            <span class="text-gray-600"><strong>Safety:</strong> ${article.safety}</span>
                            <span class="text-gray-600"><strong>Technicality:</strong> ${article.technicality}</span>
                            <span class="text-gray-600"><strong>Surprisal:</strong> ${article.surprisal}</span>
                        </div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderFailureModeToggles() {
            const container = document.getElementById('failureModeToggles');
            container.innerHTML = '';

            FAILURE_MODES.forEach(mode => {
                const isSelected = selectedFailureModes.size === 0 || selectedFailureModes.has(mode);
                const toggle = document.createElement('button');
                const iconClass = FAILURE_MODE_ICONS[mode];
                toggle.className = 'px-4 py-2 rounded-md font-medium transition flex items-center gap-2 border';
                toggle.style.cssText = isSelected
                    ? 'background-color: #f3f4f6; color: #1f2937; border-color: #475569;'
                    : 'background-color: #f3f4f6; color: #1f2937; border-color: #e5e7eb;';
                toggle.setAttribute('title', formatLabel(mode));
                toggle.innerHTML = `
                    ${iconClass ? `<i class="${iconClass} text-base" aria-hidden="true"></i>` : ''}
                    <span>${formatLabel(mode)}</span>
                `;
                toggle.addEventListener('click', () => toggleFailureMode(mode));
                container.appendChild(toggle);
            });
        }

        function toggleFailureMode(mode) {
            if (selectedFailureModes.has(mode)) {
                selectedFailureModes.delete(mode);
            } else {
                selectedFailureModes.add(mode);
            }
            renderFailureModeToggles();
            updateView();
        }

        function renderPrimaryFocusToggles() {
            const container = document.getElementById('primaryFocusToggles');
            container.innerHTML = '';

            PRIMARY_FOCUSES.forEach(focus => {
                const isSelected = selectedPrimaryFocuses.size === 0 || selectedPrimaryFocuses.has(focus);
                const toggle = document.createElement('button');
                const color = PRIMARY_FOCUS_COLORS[focus] || '#4E61D3';
                const iconClass = PRIMARY_FOCUS_ICONS[focus];
                const activeStyles = `background-color: ${color}1a; color: #1f2937; border-color: ${color};`;
                const inactiveStyles = 'background-color: #f3f4f6; color: #1f2937; border-color: #e5e7eb;';
                toggle.className = 'px-4 py-2 rounded-md font-medium transition flex items-center gap-2 border';
                toggle.style.cssText = isSelected ? activeStyles : inactiveStyles;
                toggle.dataset.focusColor = color;
                toggle.setAttribute('title', formatLabel(focus));
                toggle.innerHTML = `
                    ${iconClass ? `<i class="${iconClass} text-base" aria-hidden="true"></i>` : ''}
                    <span>${formatLabel(focus)}</span>
                `;
                toggle.addEventListener('click', () => togglePrimaryFocus(focus));
                container.appendChild(toggle);
            });
        }

        function togglePrimaryFocus(focus) {
            if (selectedPrimaryFocuses.has(focus)) {
                selectedPrimaryFocuses.delete(focus);
            } else {
                selectedPrimaryFocuses.add(focus);
            }
            renderPrimaryFocusToggles();
            updateView();
        }

        function encodeSelectedCategories() {
            if (selectedFailureModes.size === 0 && selectedPrimaryFocuses.size === 0) {
                return GRID_KEYS.map(() => '0').join('');
            }

            const failures = selectedFailureModes.size ? Array.from(selectedFailureModes) : FAILURE_MODES;
            const focuses = selectedPrimaryFocuses.size ? Array.from(selectedPrimaryFocuses) : PRIMARY_FOCUSES;
            const combos = new Set();
            failures.forEach(fm => {
                focuses.forEach(pf => combos.add(`${fm}:${pf}`));
            });

            return GRID_KEYS.map(key => (combos.has(key) ? '1' : '0')).join('');
        }

        function decodeSelectedCategories(encoded) {
            if (!encoded || encoded.length !== GRID_KEYS.length) {
                selectedFailureModes = new Set();
                selectedPrimaryFocuses = new Set();
                return;
            }

            const combos = new Set();
            GRID_KEYS.forEach((key, idx) => {
                if (encoded[idx] === '1') {
                    combos.add(key);
                }
            });

            if (combos.size === 0) {
                selectedFailureModes = new Set();
                selectedPrimaryFocuses = new Set();
                return;
            }

            const failuresInCombos = new Set();
            const focusesInCombos = new Set();
            combos.forEach(key => {
                const [fm, pf] = key.split(':');
                failuresInCombos.add(fm);
                focusesInCombos.add(pf);
            });

            selectedFailureModes = failuresInCombos.size === FAILURE_MODES.length ? new Set() : failuresInCombos;
            selectedPrimaryFocuses = focusesInCombos.size === PRIMARY_FOCUSES.length ? new Set() : focusesInCombos;
        }

        function updateURL() {
            const filters = getCurrentFilters();
            const params = new URLSearchParams();

            if (filters.dateFilter.type !== '7') {
                params.set('date', filters.dateFilter.type);
                if (filters.dateFilter.type === 'custom') {
                    if (filters.dateFilter.start) params.set('dateStart', filters.dateFilter.start);
                    if (filters.dateFilter.end) params.set('dateEnd', filters.dateFilter.end);
                }
            }

            const hasNonZeroWeight = Object.values(filters.weights).some(w => w > 0);
            if (hasNonZeroWeight) {
                params.set('weights', Object.values(filters.weights).join(','));
            }

            const categoriesBinary = encodeSelectedCategories();
            if (categoriesBinary.includes('1')) {
                params.set('categories', categoriesBinary);
            }

            const feedArray = Array.from(selectedFeeds);
            if (feedArray.length > 0 && feedArray.length < allFeeds.length) {
                params.set('feeds', feedArray.join(','));
            }

            // Only persist sidebar state if it differs from default
            const isLargeScreen = window.innerWidth >= 1024;
            const defaultState = isLargeScreen;
            if (sidebarOpen !== defaultState) {
                params.set('sidebar', sidebarOpen ? '1' : '0');
            }

            // Persist customization settings only if different from defaults
            if (!showSummary) params.set('hideSummary', '1');
            if (!showSummaryCn) params.set('hideSummaryCn', '1');
            if (!showKeywords) params.set('hideKeywords', '1');
            if (!showScores) params.set('hideScores', '1');
            if (!showAuthors) params.set('hideAuthors', '1');

            const url = params.toString() ? `?${params.toString()}` : window.location.pathname;
            window.history.replaceState({}, '', url);
        }

        function loadStateFromURL() {
            const params = new URLSearchParams(window.location.search);

            if (params.has('date')) {
                const dateType = params.get('date');
                document.getElementById('dateQuick').value = dateType;
                if (dateType === 'custom') {
                    document.getElementById('customDateRange').classList.remove('hidden');
                    if (params.has('dateStart')) {
                        document.getElementById('dateStart').value = params.get('dateStart');
                    }
                    if (params.has('dateEnd')) {
                        document.getElementById('dateEnd').value = params.get('dateEnd');
                    }
                }
            }

            if (params.has('weights')) {
                const weights = params.get('weights').split(',').map(w => parseInt(w, 10));
                const weightKeys = ['interpretability', 'understanding', 'safety', 'technicality', 'surprisal'];
                weights.forEach((w, i) => {
                    if (!Number.isNaN(w) && weightKeys[i]) {
                        document.getElementById(`weight-${weightKeys[i]}`).value = w;
                    }
                });
            }

            if (params.has('categories')) {
                const encoded = params.get('categories');
                if (/^[01]+$/.test(encoded)) {
                    decodeSelectedCategories(encoded);
                }
            }

            if (params.has('feeds')) {
                selectedFeeds = new Set(params.get('feeds').split(',').filter(Boolean));
            } else {
                selectedFeeds = new Set();
            }

            // Load customization settings
            showSummary = !params.has('hideSummary');
            showSummaryCn = !params.has('hideSummaryCn');
            showKeywords = !params.has('hideKeywords');
            showScores = !params.has('hideScores');
            showAuthors = !params.has('hideAuthors');

            // Update checkbox states
            document.getElementById('toggle-summary').checked = showSummary;
            document.getElementById('toggle-summary-cn').checked = showSummaryCn;
            document.getElementById('toggle-keywords').checked = showKeywords;
            document.getElementById('toggle-scores').checked = showScores;
            document.getElementById('toggle-authors').checked = showAuthors;

            // Handle sidebar state
            const isLargeScreen = window.innerWidth >= 1024;
            if (params.has('sidebar')) {
                sidebarOpen = params.get('sidebar') === '1';
            } else {
                // Default: open on large screens, closed on small screens
                sidebarOpen = isLargeScreen;
            }

            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (sidebarOpen) {
                sidebar.classList.remove('-translate-x-full', 'lg:hidden');
                sidebar.classList.add('translate-x-0');
                if (!isLargeScreen) {
                    overlay.classList.remove('hidden');
                }
            } else {
                // Sidebar is closed
                if (isLargeScreen) {
                    sidebar.classList.add('lg:hidden');
                }
            }
        }

        function resetWeights() {
            const weightKeys = ['interpretability', 'understanding', 'safety', 'technicality', 'surprisal'];
            weightKeys.forEach(key => {
                document.getElementById(`weight-${key}`).value = 0;
            });
            updateWeightDisplays();
            if (sliderUpdateTimeout) {
                clearTimeout(sliderUpdateTimeout);
                sliderUpdateTimeout = null;
            }
            setSliderPendingState(false);
            updateView();
        }

        function shareLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copied to clipboard!');
            });
        }

        async function updateView() {
            if (sliderUpdateTimeout) {
                clearTimeout(sliderUpdateTimeout);
                sliderUpdateTimeout = null;
            }
            setSliderPendingState(false);
            const filters = getCurrentFilters();

            let filtered = allArticles;
            filtered = filterByDate(filtered, filters.dateFilter);
            filtered = filterByCategories(filtered);
            filtered = filterByFeeds(filtered);

            const sorted = sortArticles([...filtered], filters.weights);

            renderArticles(sorted);
            updateWeightDisplays();
            updateURL();
        }

        async function init() {
            const response = await fetch('/api/data');
            const data = await response.json();

            allArticles = data.articles;
            allFeeds = data.feeds;

            loadStateFromURL();
            renderFeedToggles();
            renderPrimaryFocusToggles();
            renderFailureModeToggles();
            updateWeightDisplays();

            document.getElementById('dateQuick').addEventListener('change', (e) => {
                const isCustom = e.target.value === 'custom';
                document.getElementById('customDateRange').classList.toggle('hidden', !isCustom);
                updateView();
            });

            document.getElementById('dateStart').addEventListener('change', () => {
                updateView();
            });
            document.getElementById('dateEnd').addEventListener('change', () => {
                updateView();
            });

            ['interpretability', 'understanding', 'safety', 'technicality', 'surprisal'].forEach(key => {
                document.getElementById(`weight-${key}`).addEventListener('input', handleSliderInput);
            });

            document.getElementById('resetWeights').addEventListener('click', resetWeights);
            document.getElementById('shareLink').addEventListener('click', shareLink);

            // Customization toggle event listeners
            document.getElementById('toggle-summary').addEventListener('change', (e) => {
                showSummary = e.target.checked;
                updateView();
            });
            document.getElementById('toggle-summary-cn').addEventListener('change', (e) => {
                showSummaryCn = e.target.checked;
                updateView();
            });
            document.getElementById('toggle-keywords').addEventListener('change', (e) => {
                showKeywords = e.target.checked;
                updateView();
            });
            document.getElementById('toggle-scores').addEventListener('change', (e) => {
                showScores = e.target.checked;
                updateView();
            });
            document.getElementById('toggle-authors').addEventListener('change', (e) => {
                showAuthors = e.target.checked;
                updateView();
            });

            // Sidebar toggle event listeners
            document.getElementById('openSidebar').addEventListener('click', () => toggleSidebar(true));
            document.getElementById('sidebarToggle').addEventListener('click', () => toggleSidebar(false));
            document.getElementById('sidebarOverlay').addEventListener('click', () => toggleSidebar(false));

            await updateView();
        }

        init();
</script>
